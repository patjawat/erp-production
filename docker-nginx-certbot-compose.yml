version: '3'

services:
  mysqlDB:
    image: ${MYSQL_VERSION}
    container_name: mysqlDB
    networks:
      web-network:
        aliases:
          - mysqlDB
    cap_add:
      - SYS_NICE
    restart: always
    environment:
      TZ: ${TZ}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_HOST: ${MYSQL_ROOT_HOST}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
    expose:
      - ${MYSQL_PORT}
    volumes:
      - ./mysql_data/mysql8.0/data:/var/lib/mysql
    command: [ "mysqld", "--max_allowed_packet=64M", "--innodb-buffer-pool-size=512M", "--innodb-log-file-size=128M", "--innodb-flush-log-at-trx-commit=2", "--innodb-flush-method=O_DIRECT", "--tmp_table_size=64M", "--max-heap-table-size=64M", "--max-connections=150", "--table-open-cache=256", "--wait_timeout=28800", "--interactive_timeout=28800", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_general_ci", "--sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION" ]

  phpmyadmin_mysql:
    image: phpmyadmin
    container_name: phpmyadmin_pma
    restart: always
    ports:
      - ${PAM_PORT}:80
    environment:
      PMA_HOST: mysqlDB
      PMA_PORT: ${MYSQL_PORT}
      UPLOAD_LIMIT: 900M
    networks:
      web-network:
        aliases:
          - phpmyadmin_pma

  erp:
    image: ${IMAGE_NAME}
    container_name: ${CONTAINER_NAME}
    platform: linux/amd64
    volumes:
      - ./app-erp/fileupload:/app/modules/filemanager/fileupload
      - ./app-erp/doc_receive:/app/doc_receive
    env_file:
      - .env
    expose:
      - 80
    networks:
      web-network:
        aliases:
          - ${CONTAINER_NAME}

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - certbot
    restart: always

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: >
      sh -c "trap exit TERM;
      while :; do
      certbot renew --webroot -w /var/www/certbot;
      sleep 12h;
      done"
      
networks:
  web-network:
    driver: bridge
